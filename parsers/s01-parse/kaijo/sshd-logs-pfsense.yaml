name: custom/sshd-logs-pfsense
description: "Parse pfSense/FreeBSD sshd and sshd-session logs (complete pfSense coverage)"
filter: "evt.Parsed.program in ['sshd', 'sshd-session']"
stage: s01-parse
#stage: none
onsuccess: next_stage

# -------------------------------------------------------------------
#  PATTERN DEFINITIONS
#  - IPv4/IPv6 handling
#  - pfSense/FreeBSD-specific SSH log formats
#  - Only patterns that pfSense actually writes
# -------------------------------------------------------------------
pattern_syntax:

  # --- IP handling (pfSense writes IPv4 + IPv6) ---
  IPv4_WORKAROUND: (?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)
  IP_WORKAROUND: (?:%{IPV6}|%{IPv4_WORKAROUND})

  # -------------------------------------------------------------------
  #  SUCCESSFUL AUTHENTICATION
  # -------------------------------------------------------------------
  # Example:
  #   Accepted keyboard-interactive/pam for admin from 2a02:... port 59208 ssh2
  #
  PF_ACCEPTED: 'Accepted %{DATA:auth_method}(?:/%{DATA:auth_module})? for %{USERNAME:user} from %{IP_WORKAROUND:src_ip} port %{NUMBER:src_port}(?: ssh2)?'

  # -------------------------------------------------------------------
  #  CONNECTION CLOSED (normal session end)
  # -------------------------------------------------------------------
  # Example:
  #   Connection closed by 192.168.x.x port 12345
  #
  PF_CONNECTION_CLOSED: 'Connection closed by %{IP_WORKAROUND:src_ip} port %{NUMBER:src_port}'

  # -------------------------------------------------------------------
  #  DISCONNECT (remote disconnect with reason)
  # -------------------------------------------------------------------
  # Example:
  #   Received disconnect from 2a02:... port 12345: reason text
  #
  PF_DISCONNECT: 'Received disconnect from %{IP_WORKAROUND:src_ip} port %{NUMBER:src_port}: %{GREEDYDATA:reason}'

  # -------------------------------------------------------------------
  #  PERMISSION DENIED (FreeBSD-specific)
  # -------------------------------------------------------------------
  # Example:
  #   process_output: ssh_packet_write_poll: Connection from user admin ... Permission denied
  #
  PF_PERMISSION_DENIED: 'process_output: ssh_packet_write_poll: Connection from user %{USERNAME:user} %{IP_WORKAROUND:src_ip} port %{NUMBER:src_port}: Permission denied'

  # -------------------------------------------------------------------
  #  PAM AUTHENTICATION ERROR (FreeBSD-specific)
  # -------------------------------------------------------------------
  # Example:
  #   error: PAM: Authentication error for admin from 2a02:...
  #
  PF_PAM_AUTH_ERROR: 'error: PAM: Authentication error for %{USERNAME:user} from %{IP_WORKAROUND:src_ip}'

  # -------------------------------------------------------------------
  #  POSTPONED KEYBOARD-INTERACTIVE (preauth)
  # -------------------------------------------------------------------
  # Example:
  #   Postponed keyboard-interactive for admin from ... port 56776 ssh2 [preauth]
  #
  PF_POSTPONED_KI: 'Postponed keyboard-interactive for %{USERNAME:user} from %{IP_WORKAROUND:src_ip} port %{NUMBER:src_port}(?: %{WORD})? ssh2 \[preauth\]'

  # -------------------------------------------------------------------
  #  TIMEOUT BEFORE AUTHENTICATION
  # -------------------------------------------------------------------
  # Example:
  #   Timeout before authentication for connection from ... to ..., pid = 12345
  #
  PF_TIMEOUT_AUTH: 'Timeout before authentication for connection from %{IP_WORKAROUND:src_ip} to %{IP_WORKAROUND:dst_ip}, pid = %{NUMBER:pid}'

  # -------------------------------------------------------------------
  #  SSHGUARD EVENTS (ignored)
  # -------------------------------------------------------------------
  # Example:
  #   sshguard[PID]: Attack from ...
  #
  PF_SSHGUARD: 'sshguard\[%{NUMBER:pid}\]: %{GREEDYDATA:sshguard_msg}'


# -------------------------------------------------------------------
#  NODE DEFINITIONS
#  - Each pattern sets log_type, user, source_ip
#  - sshguard events are marked as ignored
# -------------------------------------------------------------------
nodes:

  # --- Successful authentication ---
  - grok:
      name: "PF_ACCEPTED"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_success
        - meta: target_user
          expression: "evt.Parsed.user"
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- Normal session close ---
  - grok:
      name: "PF_CONNECTION_CLOSED"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_closed
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- Disconnect with reason ---
  - grok:
      name: "PF_DISCONNECT"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_disconnect
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- Permission denied ---
  - grok:
      name: "PF_PERMISSION_DENIED"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_permission_denied
        - meta: target_user
          expression: "evt.Parsed.user"
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- PAM authentication error ---
  - grok:
      name: "PF_PAM_AUTH_ERROR"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_pam_auth_error
        - meta: target_user
          expression: "evt.Parsed.user"
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- Postponed keyboard-interactive (preauth) ---
  - grok:
      name: "PF_POSTPONED_KI"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_preauth_postponed
        - meta: target_user
          expression: "evt.Parsed.user"
        - meta: source_ip
          expression: "evt.Parsed.src_ip"

  # --- Timeout before authentication ---
  - grok:
      name: "PF_TIMEOUT_AUTH"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_timeout_before_auth
        - meta: source_ip
          expression: "evt.Parsed.src_ip"
        - meta: destination_ip
          expression: "evt.Parsed.dst_ip"

  # --- sshguard events (ignored) ---
  - grok:
      name: "PF_SSHGUARD"
      apply_on: message
      statics:
        - meta: log_type
          value: sshguard_event
        - meta: ignore
          value: true


# -------------------------------------------------------------------
#  GLOBAL METADATA
# -------------------------------------------------------------------
statics:
  - meta: service
    value: ssh
